-------this year metrics-------
DEFINE start_day_idnt = '2018001';
DEFINE end_day_idnt = '2018028';
DEFINE start_wk_idnt = '201801';
DEFINE end_wk_idnt = '201804';
DEFINE mth = 'FEB';

create table month_cust_&mth as
select 
coalesce(all_cust.indiv_id , cust_yearly.indiv_id, cust_yearly_LY.indiv_id)                   as indiv_id,
tmframe.timeframe_trans                                                                       as month_trans,
tmframe.timeframe_sales                                                                       as month_sales,
tmframe.timeframe_units                                                                       as month_units,
tmframe.store_sales                                                                           as month_store_sales,
tmframe.store_gm                                                                              as month_store_gm,
tmframe_LY.timeframe_trans                                                                    as ly_month_trans,
tmframe_LY.timeframe_sales                                                                    as ly_month_sales,
tmframe_LY.timeframe_units                                                                    as ly_month_units,
tmframe_LY.store_sales                                                                        as ly_month_store_sales,
tmframe_LY.store_gm                                                                           as ly_month_store_gm,
mth.total_sales                                                                               as sales_12mth,
mth.total_trans                                                                               as trans_12mth,
mth.total_units                                                                               as units_12mth,
mth.sales_store                                                                               as store_sales_12mth,
mth.gm_store                                                                                  as store_gm_12mth,
mth.channel                                                                                   as channel_12mth,
cust.custgroup                                                                                as monthly_customer_group,
custly.custgroup                                                                              as monthly_customer_group_ly,
cust_yearly.custgroup                                                                         as yearly_customer_group,
cust_yearly_LY.custgroup                                                                      as yearly_customer_group_LY,
mthly.total_sales                                                                             as ly_sales_12mth,
mthly.total_trans                                                                             as ly_trans_12mth,
mthly.total_units                                                                             as ly_units_12mth,
mthly.sales_store                                                                             as ly_store_sales_12mth,
mthly.gm_store                                                                                as ly_store_gm_12mth,
mthly.channel                                                                                 as ly_channel_12mth,
email.emailed                                                                                 as emailed_12mth,
em_open.opens                                                                                 as email_opens_12mth,
dm_LY.direct_mail                                                                             as direct_mail_12mth,
email_LY.emailed                                                                              as emailed_12mth_LY,
em_open_LY.opens                                                                              as email_opens_12mth_LY,
dm_LY.direct_mail                                                                             as direct_mail_12mth_LY,
mvs_lvs.value_segment                                                                         as mvs_lvs,
mvs_lvs_LY.value_segment                                                                      as mvs_lvs_LY
from all_indivs_24mo_&mth                         all_cust 
left join rolling12trans_&mth                     mth                   on all_cust.indiv_id = mth.indiv_id
left join rolling12trans_LY_&mth                  mthly                 on all_cust.indiv_id = mthly.indiv_id
left join cust_groups_&mth                  cust                  on all_cust.indiv_id = cust.indiv_id
left join cust_groups_LY_&mth               custLY                on all_cust.indiv_id = custLY.indiv_id
left join timeframe_&mth                          tmframe               on all_cust.indiv_id = tmframe.indiv_id
left join timeframe_LY_&mth                       tmframe_LY            on all_cust.indiv_id = tmframe_LY.indiv_id
left join em_&mth                                 email                 on all_cust.indiv_id = email.indiv_id
left join em_open_&mth                            em_open               on all_cust.indiv_id = em_open.indiv_id
left join dm_&mth                                 dm                    on all_cust.indiv_id = dm.indiv_id
left join em_LY_&mth                              email_LY              on all_cust.indiv_id = email_LY.indiv_id
left join em_open_LY_&mth                         em_open_LY            on all_cust.indiv_id = em_open_LY.indiv_idFEB
left join dm_LY_&mth                              dm_LY                 on all_cust.indiv_id = dm_LY.indiv_id
left join value_segment_&mth                      mvs_lvs               on all_cust.indiv_id = mvs_lvs.indiv_id
left join value_segment_LY_&mth                   mvs_lvs_LY            on all_cust.indiv_id = mvs_lvs_LY.indiv_id
full outer join custgroup_yearly_&mth             cust_yearly           on all_cust.indiv_id =  cust_yearly.indiv_id
full outer join custgroup_yearly_LY_&mth          cust_yearly_LY        on all_cust.indiv_id =  cust_yearly_LY.indiv_id;

grant select on month_cust_&mth to public;

select
count(distinct indiv_id) as customers,
sum(month_trans),
sum(month_sales),
sum(month_units),
sum(month_store_sales) as store_sales,
sum(month_store_gm) as gm_sales,
sum(ly_month_trans),
sum(ly_month_sales),
sum(ly_month_units),
sum(ly_month_store_gm) as gm_sales_ly,
sum(ly_month_store_sales) as store_sales_ly,
monthly_customer_group
from month_cust_&mth
group by monthly_customer_group
